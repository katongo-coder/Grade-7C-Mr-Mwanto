<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>All Subjects Results | Grade 7C</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --light: #f4f7f6; --success: #27ae60; --danger: #e74c3c; --warning: #f39c12; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; display: flex; }
        
        /* Sidebar Styles */
        .sidebar { position: fixed; left: -260px; top: 0; height: 100%; width: 250px; background: var(--primary); color: white; transition: 0.3s; z-index: 100; padding-top: 60px; }
        .sidebar.active { left: 0; }
        .sidebar ul { list-style: none; padding: 0; }
        .sidebar li a { padding: 15px 25px; color: white; text-decoration: none; display: block; border-bottom: 1px solid #34495e; }
        .sidebar li a:hover { background: var(--accent); }
        .menu-toggle { position: fixed; top: 20px; left: 20px; z-index: 101; background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }

        .content { flex: 1; padding: 20px; transition: 0.3s; width: 100%; margin-left: 0; overflow-x: auto; }
        .sidebar.active ~ .content { margin-left: 250px; }
        .container { min-width: 1400px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        /* Header & Action Buttons */
        .header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .btn-group { display: flex; gap: 8px; }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: 500; display: flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--warning); }
        
        .search-box { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; min-width: 250px; }

        /* Analysis Cards */
        .performance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .perf-card { padding: 20px; border-radius: 8px; border: 1px solid #eee; }
        .top-performers { border-left: 5px solid var(--success); background: #f0fff4; }
        .bottom-performers { border-left: 5px solid var(--danger); background: #fff5f5; }

        /* Table Styles */
        .results-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .results-table th { background: var(--primary); color: white; padding: 10px 5px; border: 1px solid #ddd; text-align: center; }
        .results-table td { padding: 10px 5px; border: 1px solid #eee; text-align: center; }
        .name-col { text-align: left !important; padding-left: 10px !important; font-weight: bold; }
        .total-col { font-weight: bold; background: #edf2f7; }
        .summary-row { background: #f1f4f9 !important; font-weight: bold; color: var(--primary); }

        @media print { 
            @page { size: A4 landscape; margin: 5mm; }
            .sidebar, .menu-toggle, .header-actions, .performance-grid { display: none !important; } 
            .content { margin: 0; padding: 0; }
            .container { box-shadow: none; min-width: 100%; padding: 0; }
            .results-table { font-size: 9px; }
            .results-table th { background-color: #2c3e50 !important; color: white !important; -webkit-print-color-adjust: exact; }
            .summary-row { background-color: #f1f4f9 !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞ Menu</button>
    <nav class="sidebar" id="sidebar">
        <ul>
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="enrollment.html">Enrollment</a></li>
            <li><a href="daily_register.html">Daily Register</a></li>
            <li><a href="mark_entry.html">Enter Marks</a></li>
            <li><a href="view_marks.html">Main Results</a></li>
            <li><a href="all_subjects_results.html" style="background:var(--accent)">All Subjects View</a></li>
            <li><a href="term_attendance.html">Term Attendance</a></li>
        </ul>
    </nav>

    <main class="content">
        <div class="container">
            <div class="header-actions">
                <h1>Full Subject Performance Report</h1>
                <div class="btn-group">
                    <input type="text" id="searchInput" class="search-box" placeholder="Search learner name..." onkeyup="filterTable()">
                    <button class="btn btn-primary" onclick="exportToPDF()">PDF Export</button>
                    <button class="btn btn-success" onclick="backupData()">Backup JSON</button>
                    <button class="btn btn-warning" onclick="document.getElementById('importFile').click()">Restore/Merge</button>
                    <input type="file" id="importFile" style="display:none" onchange="restoreData(this)">
                </div>
            </div>

            <div class="performance-grid">
                <div class="perf-card top-performers">
                    <h3 style="margin-top:0; color:var(--success)">üåü Top 10 Performers (Total Marks)</h3>
                    <div id="top-list"></div>
                </div>
                <div class="perf-card bottom-performers">
                    <h3 style="margin-top:0; color:var(--danger)">‚ö†Ô∏è Support Required (10 Lowest Performing)</h3>
                    <div id="bottom-list"></div>
                </div>
            </div>

            <table class="results-table" id="results-table">
                <thead>
                    <tr>
                        <th class="name-col">Learner Name</th>
                        <th>Sex</th>
                        <th>Math</th>
                        <th>Sci</th>
                        <th>Tech</th>
                        <th>Z/L</th>
                        <th>Eng</th>
                        <th>H.E</th>
                        <th>S.S</th>
                        <th>Arts</th>
                        <th class="total-col">Total Marks</th>
                        <th>Position</th>
                    </tr>
                </thead>
                <tbody id="results-body"></tbody>
                <tfoot id="results-foot"></tfoot>
            </table>
        </div>
    </main>

    <script>
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }

        const subjects = ['math', 'science', 'tech', 'zl', 'english', 'he', 'ss', 'arts'];

        function loadResults() {
            const students = JSON.parse(localStorage.getItem('grade7C_data')) || [];
            const tbody = document.getElementById('results-body');
            const tfoot = document.getElementById('results-foot');
            
            let stats = {
                boys: { math:0, science:0, tech:0, zl:0, english:0, he:0, ss:0, arts:0, grandTotal:0, count:0 },
                girls: { math:0, science:0, tech:0, zl:0, english:0, he:0, ss:0, arts:0, grandTotal:0, count:0 }
            };

            let scoredStudents = students.map(s => {
                const m = s.marks || {};
                let studentSum = 0;
                
                subjects.forEach(sub => {
                    const score = parseFloat(m[sub]) || 0;
                    studentSum += score;
                });

                const gender = s.gender || 'N/A';
                const isBoy = (gender.toLowerCase() === 'boy');
                const target = isBoy ? stats.boys : stats.girls;
                
                subjects.forEach(sub => target[sub] += (parseFloat(m[sub]) || 0));
                target.grandTotal += studentSum;
                target.count++;

                return { ...s, total: studentSum, marks: m, sex: gender };
            });

            // SORT: Highest total marks first (Descending Order)
            scoredStudents.sort((a, b) => b.total - a.total);

            tbody.innerHTML = scoredStudents.map((s, index) => {
                return `
                    <tr>
                        <td class="name-col">${s.name}</td>
                        <td>${s.sex}</td>
                        ${subjects.map(sub => `<td>${s.marks[sub] || 0}%</td>`).join('')}
                        <td class="total-col">${s.total.toFixed(0)}</td>
                        <td style="font-weight:bold;">${index + 1}</td>
                    </tr>
                `;
            }).join('');

            const calcMean = (sum, count) => count > 0 ? (sum / count).toFixed(1) : "0.0";

            function buildFooterRow(label, statObj) {
                return `
                    <tr class="summary-row">
                        <td class="name-col" colspan="2">${label} (${statObj.count})</td>
                        ${subjects.map(sub => `<td>${calcMean(statObj[sub], statObj.count)}%</td>`).join('')}
                        <td class="total-col">${calcMean(statObj.grandTotal, statObj.count)}</td>
                        <td>-</td>
                    </tr>
                `;
            }

            let grandTotalStats = { count: stats.boys.count + stats.girls.count };
            subjects.forEach(sub => grandTotalStats[sub] = stats.boys[sub] + stats.girls[sub]);
            grandTotalStats.grandTotal = stats.boys.grandTotal + stats.girls.grandTotal;

            tfoot.innerHTML = buildFooterRow("Total Boys Avg", stats.boys) + 
                              buildFooterRow("Total Girls Avg", stats.girls) + 
                              buildFooterRow("GRAND CLASS MEAN", grandTotalStats);

            // ANALYSIS CARDS - UPDATED LOGIC
            // 1. Top 10 Performers
            document.getElementById('top-list').innerHTML = scoredStudents.slice(0, 10).map((s, i) => 
                `<div style="font-size: 0.9em; margin-bottom: 2px;">${i+1}. ${s.name} - <strong>${s.total.toFixed(0)} Marks</strong></div>`
            ).join('') || "No data available";

            // 2. 10 Lowest Performing (Support Required)
            // We take the last 10 elements from the sorted list and reverse them so the very lowest is at the top
            const supportList = [...scoredStudents].reverse().slice(0, 10);
            document.getElementById('bottom-list').innerHTML = supportList.map((s, i) => 
                `<div style="font-size: 0.9em; margin-bottom: 2px;">‚Ä¢ ${s.name} (Total: ${s.total.toFixed(0)})</div>`
            ).join('') || "No data available";
        }

        // Feature Implementations
        function filterTable() {
            const input = document.getElementById("searchInput");
            const filter = input.value.toUpperCase();
            const rows = document.getElementById("results-body").getElementsByTagName("tr");
            for (let row of rows) {
                const name = row.getElementsByTagName("td")[0].innerText;
                row.style.display = name.toUpperCase().indexOf(filter) > -1 ? "" : "none";
            }
        }

        function backupData() {
            const data = localStorage.getItem('grade7C_data');
            const blob = new Blob([data], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Grade7C_Results_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function restoreData(input) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    localStorage.setItem('grade7C_data', JSON.stringify(importedData));
                    alert("Data restored/merged successfully!");
                    loadResults();
                } catch (err) {
                    alert("Invalid JSON file.");
                }
            };
            reader.readAsText(input.files[0]);
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            
            doc.setFontSize(18);
            doc.text("Puta Primary School Grade 7C - Mark Schedule Term 1 2026 For Mr Mwanto", 14, 15);
            
            doc.autoTable({
                html: '#results-table',
                startY: 25,
                theme: 'grid',
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [44, 62, 80] },
                footStyles: { fillColor: [241, 244, 249], textColor: [44, 62, 80], fontStyle: 'bold' }
            });

            doc.save(`Mr_Mwanto_Grade7C_Mark_Schedule_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        window.onload = loadResults;
    </script>
</body>
</html>